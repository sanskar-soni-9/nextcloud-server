/*! third party licenses: dist/vendor.LICENSE.txt */
import{_ as y}from"./preload-helper-BG02UnR2.mjs";import{bS as p,bY as n,b as _,v as f,l as C,D as b,F as v,P as D,aL as N,bT as w,a$ as T,b$ as I,c0 as M}from"../core-common.mjs";import{n as A,aj as x}from"./icons-DENytzON.mjs";import"./index-7XKGWWeV.mjs";import{z as c,U as E,A as S}from"./_plugin-vue2_normalizer-VrK6B12S-B9aYHv6f.mjs";import{a as k,c as d}from"./GetComments-BcCPPtc4.mjs";import{l as m}from"./logger-Dp4fPXsK.mjs";function u(e,s=1){const a=new DOMParser;let o=e;for(let i=0;i<s;i++)o=a.parseFromString(o,"text/html").documentElement.textContent;return o}async function $(e,s,a){const o=["",e,s].join("/"),i=await p.post(k()+o,{actorDisplayName:n().displayName,actorId:n().uid,actorType:"users",creationDateTime:new Date().toUTCString(),message:a,objectType:e,verb:"comment"}),h=parseInt(i.headers["content-location"].split("/").pop()),g=o+"/"+h,l=await d.stat(g,{details:!0}),r=l.data.props;return r.actorDisplayName=u(r.actorDisplayName,2),r.message=u(r.message,2),l.data}async function j(e,s,a){const o=["",e,s,a].join("/");await d.deleteFile(o)}async function L(e,s,a,o){const i=["",e,s,a].join("/");return await d.customRequest(i,Object.assign({method:"PROPPATCH",data:'<?xml version="1.0"?>\n			<d:propertyupdate\n				xmlns:d="DAV:"\n				xmlns:oc="http://owncloud.org/ns">\n			<d:set>\n				<d:prop>\n					<oc:message>'.concat(o,"</oc:message>\n				</d:prop>\n			</d:set>\n			</d:propertyupdate>")}))}const O={props:{id:{type:Number,default:null},message:{type:String,default:""},resourceId:{type:[String,Number],required:!0},resourceType:{type:String,default:"files"}},data(){return{deleted:!1,editing:!1,loading:!1}},methods:{onEdit(){this.editing=!0},onEditCancel(){this.editing=!1,this.updateLocalMessage(this.message)},async onEditComment(e){this.loading=!0;try{await L(this.resourceType,this.resourceId,this.id,e),m.debug("Comment edited",{resourceType:this.resourceType,resourceId:this.resourceId,id:this.id,message:e}),this.$emit("update:message",e),this.editing=!1}catch(s){c(t("comments","An error occurred while trying to edit the comment")),console.error(s)}finally{this.loading=!1}},onDeleteWithUndo(){this.deleted=!0;const e=setTimeout(this.onDelete,E);S(t("comments","Comment deleted"),()=>{clearTimeout(e),this.deleted=!1})},async onDelete(){try{await j(this.resourceType,this.resourceId,this.id),m.debug("Comment deleted",{resourceType:this.resourceType,resourceId:this.resourceId,id:this.id}),this.$emit("delete",this.id)}catch(e){c(t("comments","An error occurred while trying to delete the comment")),console.error(e),this.deleted=!1}},async onNewComment(e){this.loading=!0;try{const s=await $(this.resourceType,this.resourceId,e);m.debug("New comment posted",{resourceType:this.resourceType,resourceId:this.resourceId,newComment:s}),this.$emit("new",s),this.$emit("update:message",""),this.localMessage=""}catch(s){c(t("comments","An error occurred while trying to create the comment")),console.error(s)}finally{this.loading=!1}}}},P=()=>y(()=>import("../core-common.mjs").then(e=>e.e8),[],import.meta.url),R={name:"Comment",components:{ArrowRight:x,NcActionButton:_,NcActions:f,NcActionSeparator:C,NcAvatar:b,NcButton:v,NcDateTime:D,NcRichContenteditable:P},mixins:[N,O],inheritAttrs:!1,props:{actorDisplayName:{type:String,required:!0},actorId:{type:String,required:!0},creationDateTime:{type:String,default:null},editor:{type:Boolean,default:!1},autoComplete:{type:Function,required:!0},tag:{type:String,default:"div"}},data(){return{expanded:!1,localMessage:"",submitted:!1}},computed:{isOwnComment(){return n().uid===this.actorId},renderedContent(){return this.isEmptyMessage?"":this.renderContent(this.localMessage)},isEmptyMessage(){return!this.localMessage||this.localMessage.trim()===""},timestamp(){return Date.parse(this.creationDateTime)}},watch:{message(e){this.updateLocalMessage(e)}},beforeMount(){this.updateLocalMessage(this.message)},methods:{t:w,updateLocalMessage(e){this.localMessage=e.toString(),this.submitted=!1},onSubmit(){if(this.localMessage.trim()!==""){if(this.editor){this.onNewComment(this.localMessage.trim()),this.$nextTick(()=>{this.$refs.editor.$el.focus()});return}this.onEditComment(this.localMessage.trim())}},onExpand(){this.expanded=!0}}};var B=function(){var e=this,s=e._self._c;return s(e.tag,{directives:[{name:"show",rawName:"v-show",value:!e.deleted,expression:"!deleted"}],tag:"component",staticClass:"comment",class:{"comment--loading":e.loading}},[s("div",{staticClass:"comment__side"},[s("NcAvatar",{staticClass:"comment__avatar",attrs:{"display-name":e.actorDisplayName,user:e.actorId,size:32}})],1),s("div",{staticClass:"comment__body"},[s("div",{staticClass:"comment__header"},[s("span",{staticClass:"comment__author"},[e._v(e._s(e.actorDisplayName))]),e.isOwnComment&&e.id&&!e.loading?s("NcActions",{staticClass:"comment__actions"},[e.editing?s("NcActionButton",{attrs:{icon:"icon-close"},on:{click:e.onEditCancel}},[e._v(" "+e._s(e.t("comments","Cancel edit"))+" ")]):[s("NcActionButton",{attrs:{"close-after-click":!0,icon:"icon-rename"},on:{click:e.onEdit}},[e._v(" "+e._s(e.t("comments","Edit comment"))+" ")]),s("NcActionSeparator"),s("NcActionButton",{attrs:{"close-after-click":!0,icon:"icon-delete"},on:{click:e.onDeleteWithUndo}},[e._v(" "+e._s(e.t("comments","Delete comment"))+" ")])]],2):e._e(),e.id&&e.loading?s("div",{staticClass:"comment_loading icon-loading-small"}):e.creationDateTime?s("NcDateTime",{staticClass:"comment__timestamp",attrs:{timestamp:e.timestamp,"ignore-seconds":!0}}):e._e()],1),e.editor||e.editing?s("form",{staticClass:"comment__editor",on:{submit:function(a){a.preventDefault()}}},[s("div",{staticClass:"comment__editor-group"},[s("NcRichContenteditable",{ref:"editor",attrs:{"auto-complete":e.autoComplete,contenteditable:!e.loading,label:e.editor?e.t("comments","New comment"):e.t("comments","Edit comment"),placeholder:e.t("comments","Write a comment â€¦"),value:e.localMessage,"user-data":e.userData,"aria-describedby":"tab-comments__editor-description"},on:{"update:value":e.updateLocalMessage,submit:e.onSubmit}}),s("div",{staticClass:"comment__submit"},[s("NcButton",{attrs:{type:"tertiary-no-background","native-type":"submit","aria-label":e.t("comments","Post comment"),disabled:e.isEmptyMessage},on:{click:e.onSubmit},scopedSlots:e._u([{key:"icon",fn:function(){return[e.loading?s("span",{staticClass:"icon-loading-small"}):s("ArrowRight",{attrs:{size:20}})]},proxy:!0}],null,!1,2357784758)})],1)],1),s("div",{staticClass:"comment__editor-description",attrs:{id:"tab-comments__editor-description"}},[e._v(" "+e._s(e.t("comments","@ for mentions, : for emoji, / for smart picker"))+" ")])]):s("div",{staticClass:"comment__message",class:{"comment__message--expanded":e.expanded},domProps:{innerHTML:e._s(e.renderedContent)},on:{click:e.onExpand}})])])},q=[],F=A(R,B,q,!1,null,"e5fda87b");const J=F.exports,K=T({props:{resourceId:{type:Number,required:!0},resourceType:{type:String,default:"files"}},data(){return{editorData:{actorDisplayName:n().displayName,actorId:n().uid,key:"editor"},userData:{}}},methods:{async autoComplete(e,s){const{data:a}=await p.get(I("core/autocomplete/get"),{params:{search:e,itemType:"files",itemId:this.resourceId,sorter:"commenters|share-recipients",limit:M("comments","maxAutoCompleteResults")}});return a.ocs.data.forEach(o=>{this.userData[o.id]=o}),s(Object.values(this.userData))},genMentionsData(e){return Object.values(e).flat().forEach(s=>{var a;this.userData[s.mentionId]={icon:"icon-user",id:s.mentionId,label:s.mentionDisplayName,source:"users",primary:((a=n())==null?void 0:a.uid)===s.mentionId}}),this.userData}}});export{J as C,K as a};
