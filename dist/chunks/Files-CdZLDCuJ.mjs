/*! third party licenses: dist/vendor.LICENSE.txt */
import{c as w,C as v,j as b,k as g,l as y}from"./index-CPCGRGcp.mjs";import{bY as u,c2 as f,ca as q,cb as C}from"../core-common.mjs";import{c as R,u as x}from"./index-BxKJ4nfQ.mjs";import{l as z}from"./logger-abzvQ-j7.mjs";var l;const c="/files/".concat((l=u())==null?void 0:l.uid),A=f("dav"+c),D=(r=A)=>{const t=R(r),n=e=>{t==null||t.setHeaders({"X-Requested-With":"XMLHttpRequest",requesttoken:e!=null?e:""})};return q(n),n(C()),x().patch("fetch",(e,a)=>{const o=a.headers;return o!=null&&o.method&&(a.method=o.method,delete o.method),fetch(e,a)}),t},E=function(r){return r.split("").reduce(function(t,n){return t=(t<<5)-t+n.charCodeAt(0),t&t},0)},H=D(),m=function(r){var t;const n=(t=u())==null?void 0:t.uid;if(!n)throw new Error("No user id found");const e=r.props,a=b(e==null?void 0:e.permissions),o=(e["owner-id"]||n).toString(),s=f("dav"+c+r.filename),i={id:(e==null?void 0:e.fileid)<0?E(s):(e==null?void 0:e.fileid)||0,source:s,mtime:new Date(r.lastmod),mime:r.mime||"application/octet-stream",size:(e==null?void 0:e.size)||0,permissions:a,owner:o,root:c,attributes:{...r,...e,hasPreview:e==null?void 0:e["has-preview"],failed:(e==null?void 0:e.fileid)<0}};return delete i.attributes.props,r.type==="file"?new g(i):new y(i)},X=(r="/")=>{const t=new AbortController,n=w();return new v(async(e,a,o)=>{o(()=>t.abort());try{const s=await H.getDirectoryContents(r,{details:!0,data:n,includeSelf:!0,signal:t.signal}),i=s.data[0],p=s.data.slice(1);if(i.filename!==r)throw new Error("Root node does not match requested path");e({folder:m(i),contents:p.map(d=>{try{return m(d)}catch(h){return z.error("Invalid node detected '".concat(d.basename,"'"),{error:h}),null}}).filter(Boolean)})}catch(s){a(s)}})};export{X as a,D as g,E as h,m as r};
